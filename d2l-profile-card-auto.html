<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-organization-hm-behavior/d2l-organization-hm-behavior.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="d2l-profile-card.html">

<dom-module id="d2l-profile-card-auto">
	<template>
		<iron-ajax
			id="userRequest"
			url="[[userUrl]]"
			headers="[[_headers]]"
			on-iron-ajax-response="_onUserResponse"
		></iron-ajax>

		<iron-ajax
			id="enrollmentsRequest"
			url="[[_enrollmentsUrl]]"
			headers="[[_headers]]"
			on-iron-ajax-response="_onEnrollmentsResponse"
		></iron-ajax>

		<iron-ajax
			id="organizationsRequest"
			url="[[_organizationsUrl]]"
			headers="[[_headers]]"
			on-iron-ajax-response="_onOrganizationsResponse"
		></iron-ajax>

		<iron-ajax
			id="institutionRequest"
			url="[[_institutionUrl]]"
			headers="[[_headers]]"
			on-iron-ajax-response="_onInstitutionResponse"
		></iron-ajax>

		<iron-ajax
			id="organizationImageRequest"
			url="[[_organizationImageUrl]]"
			headers="[[_headers]]"
			on-iron-ajax-response="_onOrganizationImageResponse"
		></iron-ajax>

		<d2l-profile-card
			name=[[_name]]
			school=[[_school]]
			icon=[[_iconUrl]]
			background=[[_backgroundUrl]]
		>
			<slot></slot>
		</d2l-profile-card>
	</template>
	<script>
	'use strict';
	Polymer({
		is: 'd2l-profile-card-auto',
		properties: {
			userUrl: String,
			token: String,
			_authorization: String,
			_backgroundUrl: String,
			_enrollmentsUrl: String,
			_headers: String,
			_iconUrl: String,
			_institutionUrl: String,
			_name: String,
			_organizationsUrl: String,
			_organizationImageUrl: String,
			_previousUserCall: Object,
			_school: String,
			_sirenParser: String
		},
		observers: [
			'_onUserChange( userUrl, token )'
		],
		behaviors: [ window.D2L.Hypermedia.OrganizationHMBehavior ],
		ready: function() {
			this._generateUserRequest();
		},
		_onUserChange: function(userUrl, token) {
			this._generateUserRequest();
		},
		_generateUserRequest: function() {
			this._previousUserCall = this._previousUserCall || {};
			if (
				this.userUrl &&
				this.token &&
				this.userUrl !== this._previousUserCall.userUrl &&
				this.token !== this._previousUserCall.token
			) {
				this._previousUserCall = { userUrl: this.userUrl, token: this.token };
				this._authorization = 'Bearer ' + this.token;
				this._headers = {
					Authorization: this._authorization,
					Accept: 'application/vnd.siren+json'
				};
				this.$.userRequest.generateRequest();
			}
		},
		_onUserResponse: function(response) {
			if (response.detail.status === 200) {
				this._parser = this._parser || document.createElement('d2l-siren-parser');
				var userResponse = this._parser.parse(response.detail.xhr.response);
				this._name = (userResponse.getSubEntityByRel('https://api.brightspace.com/rels/display-name') || { properties: {}}).properties.name;
				var profile = userResponse.getSubEntityByRel('https://api.brightspace.com/rels/user-profile');
				if (profile) {
					var image = profile.getSubEntitiesByRel('https://api.brightspace.com/rels/profile-image')[0];
					this._iconUrl = (image.getLinkByRel('https://api.brightspace.com/rels/thumbnail#regular') || {}).href;
				}

				this._enrollmentsUrl = (userResponse.getLinkByRel('https://api.brightspace.com/rels/my-enrollments') || {}).href;
				if ( this._enrollmentsUrl ) {
                    this._enrollmentsUrl += '?pageSize=2&orgUnitTypeId=3&embedDepth=1'; // also maybe embedDepth=1
					this.$.enrollmentsRequest.generateRequest();
				}
			}
		},
		_onEnrollmentsResponse: function(response) {
			if (response.detail.status === 200) {
				var enrollmentsResponse = this._parser.parse(response.detail.xhr.response);
				this._institutionUrl = ( enrollmentsResponse.getLinkByRel('https://api.brightspace.com/rels/organization') || {}).href;

				if ( this._institutionUrl ) {
					this.$.institutionRequest.generateRequest();
				}

                if (enrollmentsResponse.entities.length > 0) { // Or '=== 1'
                    this._organizationsUrl = enrollmentsResponse.entities[0]
                        .getLinkByRel('https://api.brightspace.com/rels/organization').href;

                    this.$.organizationsRequest.generateRequest();
                }
			}
		},
		_onInstitutionResponse: function(response) {
			if (response.detail.status === 200) {
				var institutionResponse = this._parser.parse(response.detail.xhr.response);
				if (institutionResponse.properties) {
					this._school = institutionResponse.properties.name;
				}
			}
		},
		_onOrganizationsResponse: function (response) {
			if (response.detail.status === 200) {
				var organizationsResponse = this._parser.parse(response.detail.xhr.response);
				var imageLink = organizationsResponse.getSubEntityByClass('course-image');

				if ( imageLink ) {
					this._organizationImageUrl = imageLink.href;
					this.$.organizationImageRequest.generateRequest();
				}
			}
		},
		_onOrganizationImageResponse: function (response) {
			if (response.detail.status === 200) {
				var organizationImageResponse = this._parser.parse(response.detail.xhr.response);
				var backgroundImages = this._getImageLinks(organizationImageResponse, 'wide');
				this._backgroundUrl = backgroundImages.highMin || backgroundImages.lowMax;
			}
		}
	});
	</script>
</dom-module>
